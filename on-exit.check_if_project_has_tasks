#!/usr/bin/env python3

import json
import sys
from pathlib import Path
import subprocess
from time import sleep



def check_if_task_removed_from_pending(task_json):
    with open(str(Path.home()) + '/.task/pending.data', 'r') as f:
        pending_file = f.read()
    #return not 'uuid:"' + task_json['uuid'] + '"' in pending_file
    return not task_json['uuid'] in pending_file


try:
    NEW = json.loads(sys.stdin.readline())
except:
    sys.exit(0)
try:
    if NEW['status'] == 'completed' and 'project' in NEW:
        process = subprocess.Popen(['task', 'project:'+NEW['project']], \
                stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        out, err = process.communicate()
        if out == b'':
            new_task_no_tags = ['task', 'add', 'Add task', 'project:' + NEW['project'], '+clarify']
            print('check_if_task_removed_from_pending: ' + str(check_if_task_removed_from_pending(NEW)))
            while not check_if_task_removed_from_pending(NEW):
                print('Task not yet removed')
                sleep(0.1)
            if 'tags' in NEW:
                tags = NEW['tags']
                tags = ['+' + e for e in tags]
                subprocess.run(new_task_no_tags + tags)
            else:
                tags = []
                subprocess.run(new_task_no_tags)
            print('Added "Add task" task')
except Exception as e:
    if False:
        pass
    else:
        print(e)
